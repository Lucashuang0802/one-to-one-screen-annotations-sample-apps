var AnnotationAccPack=function(){var e,n=function(n){if(!n||!this.options.canvasContainer)throw new Error("Annotation requires");this.options=n||{},this.elements={canvasContainer:this.options.canvasContainer},e=this},t=[{id:"OT_pen",title:"Pen",icon:"../images/annotation/freehand.png",selectedIcon:"../images/annotation/freehand_selected.png"},{id:"OT_line",title:"Line",icon:"../images/annotation/line.png",selectedIcon:"../images/annotation/line_selected.png"},{id:"OT_shapes",title:"Shapes",icon:"../images/annotation/shapes.png",items:[{id:"OT_arrow",title:"Arrow",icon:"../images/annotation/arrow.png"},{id:"OT_rect",title:"Rectangle",icon:"../images/annotation/rectangle.png"},{id:"OT_oval",title:"Oval",icon:"../images/annotation/oval.png"},{id:"OT_star",title:"Star",icon:"../images/annotation/star.png",points:[[.5+.5*Math.cos(90*(Math.PI/180)),.5+.5*Math.sin(90*(Math.PI/180))],[.5+.25*Math.cos(126*(Math.PI/180)),.5+.25*Math.sin(126*(Math.PI/180))],[.5+.5*Math.cos(162*(Math.PI/180)),.5+.5*Math.sin(162*(Math.PI/180))],[.5+.25*Math.cos(198*(Math.PI/180)),.5+.25*Math.sin(198*(Math.PI/180))],[.5+.5*Math.cos(234*(Math.PI/180)),.5+.5*Math.sin(234*(Math.PI/180))],[.5+.25*Math.cos(270*(Math.PI/180)),.5+.25*Math.sin(270*(Math.PI/180))],[.5+.5*Math.cos(306*(Math.PI/180)),.5+.5*Math.sin(306*(Math.PI/180))],[.5+.25*Math.cos(342*(Math.PI/180)),.5+.25*Math.sin(342*(Math.PI/180))],[.5+.5*Math.cos(18*(Math.PI/180)),.5+.5*Math.sin(18*(Math.PI/180))],[.5+.25*Math.cos(54*(Math.PI/180)),.5+.25*Math.sin(54*(Math.PI/180))],[.5+.5*Math.cos(90*(Math.PI/180)),.5+.5*Math.sin(90*(Math.PI/180))]]}]},{id:"OT_colors",title:"Colors",icon:"",items:{}},{id:"OT_line_width",title:"Line Width",icon:"../images/annotation/line_width.png",items:{}},{id:"OT_clear",title:"Clear",icon:"../images/annotation/clear.png"}],o=["#1abc9c","#2ecc71","#3498db","#9b59b6","#8e44ad","#f1c40f","#e67e22","#e74c3c","#ded5d5"],s=10/6,i=function(){$(e.elements.resizeSubject).on("resize",u)},a=function(e,n,s){var i=_.property("toolbarId")(n)||"toolbar",a=_.property("toolbarItems")(n)||t,r=_.property("colors")(n)||o,c=function(){var e=s?s:window;return e.document.getElementById(i)};toolbar=new OTSolution.Annotations.Toolbar({session:e,container:c(),colors:r,items:a,externalWindow:s||null})},r=_.throttle(function(){e.canvas.onResize()},1e3),c=function(){var e=$.Deferred(),n=.8*screen.width|0,t=n/s,o=["templates/screenshare.html?opentok-annotation"].join(""),i=["toolbar=no","location=no","directories=no","status=no","menubar=no","scrollbars=no","resizable=no","copyhistory=no","width="+n,"height="+t,"left="+(screen.width/2-n/2),"top="+(screen.height/2-t/2)].join(","),a=window.open(o,"",i);a.toolbar=toolbar,a.OT=OT,a.$=$;var r=function(){a.createContainerElements?$(a.document).ready(function(){e.resolve(a)}):setTimeout(r,100)};return r(),e.promise()},l=function(){$(e.elements.resizeSubject).off("resize",u),toolbar.remove()},h=function(e,n){var t=$.Deferred();return _.property("externalWindow")(n)?c().then(function(o){a(e,n,o),toolbar.createPanel(o),t.resolve()}):(a(e,n),t.resolve()),t.promise()},d=function(n,t,o){e.elements.resizeSubject=o||e.elements.canvasContainer,e.elements.externalWindow=o,e.elements.annotationContainer=t,e.canvas=new OTSolution.Annotations({feed:n,container:t});var s=e.elements.externalWindow?e.elements.externalWindow:window;e.elements.canvas=$(_.first(s.document.getElementsByTagName("canvas"))),toolbar.addCanvas(e.canvas),e.canvas.onScreenCapture(function(e){var n=window.open(e,"_blank");n.focus()}),i(),u()},u=function(){var n,t;if(e.elements.externalWindow){var o={width:e.elements.externalWindow.innerWidth,height:e.elements.externalWindow.innerHeight},i=o.width/s;i<=o.height?(n=o.width,t=i):(t=o.height,n=t*s)}else n=$(e.elements.canvasContainer).width(),t=$(e.elements.canvasContainer).height();$(e.elements.annotationContainer).css({width:n,height:t}),$(e.elements.canvas).css({width:n,height:t}),$(e.elements.canvas).attr({width:n,height:t}),r()},m=function(){l(),delete e.canavs,delete e.elements,e.elements.externalWindow&&e.elements.externalWindow.close()};return n.prototype={constructor:n,start:h,linkCanvas:d,resizeCanvas:u,end:m},n}(),ScreenSharingAccPack=function(){var e,n=function(n){e=this,console.log("options passed to screensharing things",n),t(n);var s=["sessionID","annotation","extensionURL","extensionID","extensionPathFF","screensharingParent"];_.extend(this,_.defaults(_.pick(n,s)),{screenSharingParent:"#videoContainer"}),o(this.extensionID),r(e.screensharingParent)},t=function(e){if(!_.property("sessionID",e))throw new Error("Screen Share Acc Pack requires a session ID");if(!_.property("extensionID")&&!_.get(e,"extensionPathFF"))throw new Error("Screen Share Acc Pack requires a Chrome or Firefox extension")},o=function(e){"Chrome"==OT.$.browser()&&OT.registerScreenSharingExtension("chrome",e,2)},s=['<div class="hidden" id="screenShareView">','<div class="wms-feed-main-video">','<div class="wms-feed-holder" id="videoHolderScreenShare"></div>','<div class="wms-feed-mask"></div>','<img src="/images/mask/video-mask.png"/>',"</div>",'<div class="wms-feed-call-controls" id="feedControlsFromScreen">','<button class="wms-icon-screen active hidden" id="endScreenShareBtn"></button>',"</div>","</div>"].join("\n"),i=['<div id="dialog-form-chrome" class="wms-modal" style="display: none;">','<div class="wms-modal-body">','<div class="wms-modal-title with-icon">','<i class="wms-icon-share-large"></i>',"<span>Screen Share<br/>Extension Installation</span>","</div>","<p>You need a Chrome extension to share your screen. Install Screensharing Extension. Once you have installed, please, click the share screen button again.</p>",'<button id="btn-install-plugin-chrome" class="wms-btn-install">Accept</button>','<button id="btn-cancel-plugin-chrome" class="wms-cancel-btn-install"></button>',"</div>","</div>",'<div id="dialog-form-ff" class="wms-modal" style="display: none;">','<div class="wms-modal-body">','<div class="wms-modal-title with-icon">','<i class="wms-icon-share-large"></i>',"<span>Screen Share<br/>Extension Installation</span>","</div>","<p>You need a Firefox extension to share your screen. Install Screensharing Extension. Once you have installed, refresh your browser and click the share screen button again.</p>",'<a href="#" id="btn-install-plugin-ff" class="wms-btn-install" href="">Install extension</a>','<a href="#" id="btn-cancel-plugin-ff" class="wms-cancel-btn-install"></a>',"</div>","</div>"].join("\n"),a=function(n,t){if("Chrome"===OT.$.browser()&&(!n||0===n.length)){var o={code:200,message:" Error starting the screensharing. You need to indicate a screensharing Chrome extensionID"};return console.log(o.code,o.message),!1}if("Firefox"===OT.$.browser()&&(!t||0==t.length)){var o={code:200,message:" Error starting the screensharing. You need to indicate a screensharing extension for Fireforx"};return console.log(o.code,o.message),!1}OT.checkScreenSharingCapability(function(n){if(console.log("checkScreenSharingCapability",n),"http:"==location.protocol)alert("Screensharing only works under 'https', please add 'https://' in front of your debugger url.");else if(n.supported&&n.extensionRegistered!==!1)if(n.extensionInstalled===!1)$("#dialog-form-chrome").toggle();else{if(console.log("The screensharing extension is installed"),n.supportedSources.window||n.supportedSources.application||n.supportedSources.browser)console.log("Supported sources: window, application  or browser.");else if(n.supportedSources.screen)console.log("Supported sources: screen");else{Object.keys(n.supportedSources).filter(function(e){return n.supportedSources[e]})}e._initPublisherScreen().then(function(n){if(console.log("resolve init publisher screen"),e.publisher=e._publish("screen"),t(),n){var o=e.comms_elements.annotationWindow;e._annotation.linkCanvas(e.publisher,n,o)}});var t=function(){e.publisher.on("streamCreated",function(n){e._handleStartScreenSharing(n)}),e.publisher.on("streamDestroyed",function(n){console.log("stream destroyed called"),e._handleEndScreenSharing(n)})}}else alert("This browser does not support screen sharing! Please test with Chrome, Firefox or IE!")})},r=function(e){$("body").append(i),$(e).append(s)};return n.prototype={constructor:n,checkExtension:a,onStarted:function(){},onEnded:function(){},onError:function(e){console.log("OT: Screen sharing error: ",e)}},n}();