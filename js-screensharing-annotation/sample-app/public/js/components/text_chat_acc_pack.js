var TextChatAccPack=function(){var e,s,t,n=!1,a=!1,i="chat-container",o=function(t){t=t||{},this._imCharacterCount=t.charCountElement,e=t.accelerator_pack,s=t.user},r=function(e){return uiLayout=['<div class="wms-widget-wrapper">','<div class="wms-widget-chat wms-widget-extras" id="chatContainer">','<div class="wms-messages-header hidden" id="chatHeader">',"<span>Chat with</span>","</div>",'<div id="wmsChatWrap">','<div class="wms-messages-holder" id="messagesHolder">','<div class="wms-message-item wms-message-sent">',"</div>","</div>",'<div class="wms-send-message-box">','<input type="text" maxlength="160" class="wms-message-input" placeholder="Enter your message here" id="messageBox">','<button class="wms-icon-check" id="sendMessage" type="submit"></button>','<div class="wms-character-count"><span><span id="character-count">0</span>/160 characters</span></div>',"</div>","</div>","</div>","</div>"].join("\n")},c=function(e){e=document.querySelector(e)||document.body;var s=document.createElement("section");s.innerHTML=r();var t=s.querySelector("#sendMessage"),n=s.querySelector("#messageBox"),a=s.querySelector("#wms-character-count > span"),i=s.querySelector("#messagesHolder");this._composer=n,this._sendButton=t,this._charCounter=a,this._bubbles=s.firstElementChild,this._newMessages=i,this._sendButton.onclick=d.bind(this._composer.value),this._composer.onkeyup=this._updateCharCounter.bind(this),this._composer.onkeydown=this._controlComposerInput.bind(this),e.appendChild(s)},m=function(e){return t&&t.user.id===e.user.id&&moment(t.sentOn).fromNow()===moment(e.sentOn).fromNow()},d=function(e){var t=this;_.isEmpty(e)||$.when(l(t._remoteParticipant,e)).then(function(n){t._handleMessageSent({user:s,message:e,sentOn:new Date}),this.futureMessageNotice&&(this.futureMessageNotice=!1)},function(e){t._handleMessageError(e)})},l=function(t,n){var a=new $.Deferred,i={message:arguments[1],user:s,sentOn:new Date};return console.log(e.getSession()),void 0===t?e.getSession().signal({type:"chat",data:i},function(e){if(e){if(e.message="Error sending a message. ",413===e.code){var s=e.message+"The chat message is over size limit.";e.message=s}else if(500===e.code){var s=e.message+"Check your network connection.";e.message=s}a.reject(e)}else console.log("Message sent"),a.resolve(i)}):e.getSession().signal({type:"chat",data:i,to:t},function(e){e?(console.log("Error sending a message"),a.resolve(e)):(console.log("Message sent"),a.resolve(i))}),a.promise()},h=function(e){if(m(e)){$(".wms-item-text").last().append("<span>"+e.message+"</span>");var s=$(this._newMessages);s[0].scrollTop=s[0].scrollHeight,this._cleanComposer()}else this._renderChatMessage(e.user,e.message,e.sentOn);t=e},u=function(e){m(e.data)?$(".wms-item-text").last().append("<span>"+e.data.message+"</span>"):this._renderChatMessage(e.data.user,e.data.message,e.data.sentOn),t=e.data},g=function(e){if(console.log(e.code,e.message),500===e.code){var s=_.template($("#chatError").html());$(this.comms_elements.messagesView).append(s())}},p=function(e,t,n){var a=s.id===e.id?"wms-message-item wms-message-sent":"wms-message-item",i=v({username:e.name,message:t,message_class:a,time:n}),o=$(this._newMessages);o.append(i),this._cleanComposer(),o[0].scrollTop=o[0].scrollHeight},v=function(e){var s=['<div class="'+e.message_class+'" >','<div class="wms-user-name-initial"> '+e.username[0]+"</div>",'<div class="wms-item-timestamp"> '+e.username+', <span data-livestamp=" '+e.time+'" </span></div>','<div class="wms-item-text">',"<span> "+e.message+"</span>","</div>","</div>"].join("\n");return s},f=function(s){var t=e.getSession().connection.connectionId,n=s.from.connectionId;if(n!==t){var a=this._onIncomingMessage(s);a&&"function"==typeof a&&a(s)}};return o.prototype={constructor:o,_cleanComposer:function(){this._composer.value="",$(this._imCharacterCount).text("0")},_controlComposerInput:function(e){var s=13===e.which||13===e.keyCode;!e.shiftKey&&s&&(e.preventDefault(),d.call(this,this._composer.value))},_updateCharCounter:function(){$(this._imCharacterCount).text(this._composer.value.length)},initTextChat:function(s){n=!0,a=!0,c.call(this,s),e.getSession().on("signal:chat",this._handleTextChat.bind(this))},showTextChat:function(){document.getElementById(i).classList.remove("hidden"),this.setDisplayTextChat(!0)},hideTextChat:function(){document.getElementById(i).classList.add("hidden"),this.setDisplayTextChat(!1)},getEnableTextChat:function(){return n},getDisplayTextChat:function(){return a},setDisplayTextChat:function(e){a=e},_handleTextChat:function(e){f.call(this,e)},_handleMessageSent:function(e){h.call(this,e)},_renderChatMessage:function(e,s,t){p.call(this,e,s,t)},_onIncomingMessage:function(e){u.call(this,e)},_handleMessageError:function(e){g.call(this,e)}},o}();